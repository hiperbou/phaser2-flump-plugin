!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["phaser-flump-plugin"]=e():t["phaser-flump-plugin"]=e()}(window,(function(){return function(t){var e={};function i(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(r,o,function(e){return t[e]}.bind(null,o));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";function r(t,e,i,r){var o=this;return i=i||[],Array.isArray(i)||(i=[i]),i.forEach((function(e){var i=e.substring(e.lastIndexOf(".")),s=e.substring(e.lastIndexOf("/")+1);o.addToFileList("image","".concat(t,"/").concat(s),e,void 0,r,i)})),this.addToFileList("json",t,e,void 0,r,".json"),this}i.r(e),Phaser.Loader.prototype.flumpAtlas=r;var o="<Empty Keyframe>",s="",a="empty",n="movie",l="image",h="PLAYING",u=-1;function f(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var c=function(){var t,e,i;function r(t){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,r),void 0===t.index)throw new Error("Keyframe is missing index field.");if(this.index=t.index,void 0===t.duration)throw new Error("Keyframe is missing duration field");this.duration=t.duration,this.ref=void 0===t.ref?o:t.ref,this.alpha=void 0===t.alpha?1:t.alpha,this.visible=void 0===t.visible||t.visible,this.ease=void 0===t.ease?0:t.ease,this.tweened=void 0===t.tweened||t.tweened,this.label=void 0===t.label?s:t.label;var e=void 0===t.loc?[0,0]:t.loc;this.x=e[0],this.y=e[1];var i=void 0===t.scale?[1,1]:t.scale;this.scaleX=i[0],this.scaleY=i[1];var a=void 0===t.skew?[0,0]:t.skew;this.skewX=a[0],this.skewY=a[1];var n=void 0===t.pivot?[0,0]:t.pivot;this.pivotX=n[0],this.pivotY=n[1]}return t=r,(e=[{key:"isEmpty",get:function(){return this.ref===o}},{key:"rotation",get:function(){return this.skewX}}])&&f(t.prototype,e),i&&f(t,i),r}();function y(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function m(t,e,i){return e&&y(t.prototype,e),i&&y(t,i),t}var d=function(){function t(e,i,r){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.library=e,this.movie=i,void 0===r.name)throw new Error("Layer data from ".concat(this.library,"/").concat(this.movie," is missing the name field."));if(this.name=r.name,this.flipbook=r.flipbook||!1,void 0===r.keyframes)throw new Error("Layer data from ".concat(this.library,"/").concat(this.movie," is missing the layframes field."));this.keyframes=r.keyframes.map((function(t){return new c(t)}))}return m(t,[{key:"frameCount",get:function(){if(0===this.keyframes.length)return 0;var t=this.keyframes[this.keyframes.length-1];return t.index+t.duration}}]),m(t,[{key:"destroy",value:function(){this.keyframes=void 0}},{key:"getKeyframeData",value:function(t){for(var e=1;e<this.keyframes.length&&this.keyframes[e].index<=t;e++);return this.keyframes[e-1]}}]),t}();function b(t){return(b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function p(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function v(t,e){return!e||"object"!==b(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function g(t,e,i){return(g="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=k(t)););return t}(t,e);if(r){var o=Object.getOwnPropertyDescriptor(r,e);return o.get?o.get.call(i):o.value}})(t,e,i||t)}function k(t){return(k=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function w(t,e){return(w=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var P=function(t){function e(t,i,r,o,s){var a;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(a=v(this,k(e).call(this,t,i,r,o,s))).symbolType=void 0,a.symbolKey=void 0,a.symbolLibrary=void 0,a.skew=new Phaser.Point(0,0),a}var i,r,o;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&w(t,e)}(e,Phaser.Image),i=e,(r=[{key:"destroy",value:function(t){this.skew=void 0,g(k(e.prototype),"destroy",this).call(this,t)}},{key:"restore",value:function(){return this.position.set(0,0),this.pivot.set(0,0),this.skew.set(0,0),this.scale.set(1,1),this.alpha=1,this.visible=!0,this}},{key:"displayObjectUpdateTransform",value:function(t){return this.symbolType===n?this.calculateTransform(t):g(k(e.prototype),"displayObjectUpdateTransform",this).call(this,t)}},{key:"updateTransform",value:function(t){return this.symbolType===l?this.calculateTransform(t):g(k(e.prototype),"updateTransform",this).call(this,t)}},{key:"calculateTransform",value:function(t){if(!t&&!this.parent&&!this.game)return this;var e=this.parent;t?e=t:this.parent||(e=this.game.world);var i,r,o,s,a,n,l=e.worldTransform,h=this.worldTransform;return this.rotation%PIXI.PI_2||this.skew.x||this.skew.y?(i=this.scale.x*Math.cos(this.rotation+this.skew.y),r=this.scale.x*Math.sin(this.rotation+this.skew.y),o=this.scale.y*Math.sin(-this.rotation-this.skew.x),s=this.scale.y*Math.cos(this.rotation+this.skew.x),a=this.position.x,n=this.position.y,(this.pivot.x||this.pivot.y)&&(a-=this.pivot.x*i+this.pivot.y*o,n-=this.pivot.x*r+this.pivot.y*s),h.a=i*l.a+r*l.c,h.b=i*l.b+r*l.d,h.c=o*l.a+s*l.c,h.d=o*l.b+s*l.d,h.tx=a*l.a+n*l.c+l.tx,h.ty=a*l.b+n*l.d+l.ty):(i=this.scale.x,s=this.scale.y,a=this.position.x-this.pivot.x*i,n=this.position.y-this.pivot.y*s,h.a=i*l.a,h.b=i*l.b,h.c=s*l.c,h.d=s*l.d,h.tx=a*l.a+n*l.c+l.tx,h.ty=a*l.b+n*l.d+l.ty),this.worldAlpha=this.alpha*e.worldAlpha,this.worldPosition.set(h.tx,h.ty),this.worldScale.set(Math.sqrt(h.a*h.a+h.b*h.b),Math.sqrt(h.c*h.c+h.d*h.d)),this.worldRotation=Math.atan2(-h.c,h.d),this._currentBounds=null,this.transformCallback&&this.transformCallback.call(this.transformCallbackContext,h,l),this}}])&&p(i.prototype,r),o&&p(i,o),e}();function S(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function T(t,e,i){return e&&S(t.prototype,e),i&&S(t,i),t}var F=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.movie=e,this.game=e.game,this.data=void 0,this.currentSymbol=void 0,this.symbols=[],this.symbolCount=0,this.disabled=!1,this.keyframeIdx=0}return T(t,[{key:"name",get:function(){return this.data.name}},{key:"library",get:function(){return this.data.library}},{key:"keyframes",get:function(){return this.data.keyframes}},{key:"frameCount",get:function(){return this.data.frameCount}},{key:"isFlipbook",get:function(){return this.data.flipbook}}]),T(t,[{key:"destroy",value:function(){for(this.movie=void 0,this.game=void 0,this.data=void 0,this.currentSymbol=void 0;this.symbols.length>0;){for(var t=this.symbols.shift(),e=this.symbols.length-1;e>=0;e--)this.symbols[e]===t&&this.symbols.splice(e,1);t.destroy()}this.symbols=void 0}},{key:"setup",value:function(t){void 0!==this.data&&this.cleanUp(),this.data=t,this.symbolCount=0;for(var e=o,i=0;i<this.keyframes.length&&e===o;i++)e=this.keyframes[i].ref;if(!this.isFlipbook&&e===o)return this.currentSymbol=this.game.flump.createSymbolFrom(this.library),this.movie.addChild(this.currentSymbol),this.symbolCount=1,this.drawFrame(0);for(var r=0;r<this.keyframes.length;++r){var s=this.keyframes[r],a=void 0;r>0&&this.keyframes[r-1].ref===s.ref?a=this.symbols[r-1]:(this.symbolCount++,s.ref===o?a=this.game.flump.createSymbolFrom(this.library):(a=this.game.flump.createSymbolFrom(this.library,s.ref)).symbolType===n&&a.setParentMovie(this.movie)),this.symbols.push(a),a.visible=!1,this.movie.addChild(a)}return this.currentSymbol=this.symbols[0],this.currentSymbol.visible=!0,this.drawFrame(0)}},{key:"replaceCurrentSymbol",value:function(t){for(var e=0;e<this.symbols.length;e++)this.symbols[e]===this.currentSymbol&&(this.symbols[e]=t);this.currentSymbol=t}},{key:"drawFrame",value:function(t){if(!this.symbols||0===this.symbols.length||this.disabled)return this;if(t>=this.frameCount)return this.currentSymbol.visible=!1,this.keyframeIdx=this.keyframes.length-1,this;for(this.keyframes[this.keyframeIdx].index>t&&(this.keyframeIdx=0);this.keyframeIdx<this.keyframes.length-1&&this.keyframes[this.keyframeIdx+1].index<=t;)this.keyframeIdx++;var e=this.symbols[this.keyframeIdx];this.currentSymbol!==e&&(this.currentSymbol.visible=!1,e.symbolType===n&&e.goToInternal(0,!0),this.currentSymbol=e);var i=this.keyframes[this.keyframeIdx],r=i.x,o=i.y,s=i.pivotX,a=i.pivotY,l=i.scaleX,h=i.scaleY,u=i.skewX,f=i.skewY,c=i.alpha;if(this.currentSymbol.visible=i.visible,this.keyframeIdx<this.keyframes.length-1&&i.index!==t&&i.tweened){var y=(t-i.index)/i.duration,m=i.ease;if(0!==m){var d;if(m<0){var b=1-y;d=1-b*b,m=-m}else d=y*y;y=m*d+(1-m)*y}var p=this.keyframes[this.keyframeIdx+1];r+=(p.x-r)*y,o+=(p.y-o)*y,s+=(p.pivotX-s)*y,a+=(p.pivotY-a)*y,l+=(p.scaleX-l)*y,h+=(p.scaleY-h)*y,u+=(p.skewX-u)*y,f+=(p.skewY-f)*y,c+=(p.alpha-c)*y}return this.updateSymbol(r,o,s,a,l,h,u,f,c),this}},{key:"updateSymbol",value:function(t,e,i,r,o,s,a,n,l){this.currentSymbol.visible&&(this.currentSymbol.position.set(t,e),this.currentSymbol.pivot.set(i,r),this.currentSymbol.skew.set(a,n),this.currentSymbol.scale.set(o,s),this.currentSymbol.alpha=l)}},{key:"cleanUp",value:function(){for(this.symbols.push(this.currentSymbol);this.symbols.length>0;){for(var t=this.symbols.shift(),e=this.symbols.length;e>=0;--e)this.symbols[e]===t&&this.symbols.splice(e,1);t.symbolType===n&&t.cleanUp(),this.movie.removeChild(t),this.game.flump.libraries[this.library].storeSymbol(t)}this.keyframeIdx=0,this.disabled=!1,this.data=void 0,this.currentSymbol=void 0}}]),t}();function x(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function E(t,e,i){return e&&x(t.prototype,e),i&&x(t,i),t}var O=function(){function t(e,i){var r=this;if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.library=e,this.id=i.id,void 0===i.layers)throw new Error("Movie data ".concat(this.id," is missing the layers field."));this.layers=i.layers.map((function(t){return new d(e,r.id,t)})),this.frameCount=0,this.layers.forEach((function(t){return r.frameCount=Math.max(r.frameCount,t.frameCount)})),this.labels=Array(this.frameCount).fill().map((function(t){return[]})),this.generateFrameLabels()}return E(t,[{key:"isFlipbook",get:function(){return this.layers.length>0&&this.layers[0].flipbook}}]),E(t,[{key:"destroy",value:function(){this.layers.forEach((function(t){return t.destroy()})),this.layers=void 0,this.labels=void 0}},{key:"generateFrameLabels",value:function(){var t=this;0!==this.labels.length&&(this.labels[0].push("<First Frame>"),this.labels[this.frameCount-1].push("<Last Frame>"),this.layers.forEach((function(e){e.keyframes.forEach((function(e){e.label!==s&&t.labels[e.index].push(e.label)}))})))}}]),t}();function C(t){return(C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function M(t,e){return!e||"object"!==C(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function j(t,e,i){return(j="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=L(t)););return t}(t,e);if(r){var o=Object.getOwnPropertyDescriptor(r,e);return o.get?o.get.call(i):o.value}})(t,e,i||t)}function L(t){return(L=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function I(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function A(t,e,i){return e&&I(t.prototype,e),i&&I(t,i),t}function _(t,e){return(_=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var D=function(t){function e(t,i){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(r=M(this,L(e).call(this,t))).data=void 0,r.frameRate=i,r.duration=0,r.layers=[],r.layerPool=[],r.parentMovie=void 0,r.framePosition=u,r.stopFrame=u,r.pendingGoToFrame=u,r.lastFrameIdx=u,r.playTime=0,r.skipAdvanceTime=!1,r.isUpdatingFrame=!1,r.fallbackLoop=void 0,r.playbackSpeed=1,r.state=h,r.labelEvents=new Phaser.Signal,r.playbackComplete=new Phaser.Signal,r.playbackLoop=new Phaser.Signal,r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_(t,e)}(e,t),A(e,[{key:"id",get:function(){return this.data.id}},{key:"library",get:function(){return this.data.library}},{key:"frameCount",get:function(){return this.data.frameCount}},{key:"labels",get:function(){return this.data.labels}},{key:"layerData",get:function(){return this.data.layers}},{key:"isFlipbook",get:function(){return this.data.isFlipbook}},{key:"isManagedByParent",get:function(){return void 0!==this.parentMovie}},{key:"isPlaying",get:function(){return this.state===h}}]),A(e,[{key:"destroy",value:function(){this.labelEvents.dispose(),this.labelEvents=void 0,this.layers.forEach((function(t){return t.destroy()})),this.layers=void 0,this.layerPool.forEach((function(t){return t.destroy()})),this.layerPool=void 0,this.data=void 0,this.parentMovie=void 0,j(L(e.prototype),"destroy",this).call(this)}},{key:"update",value:function(){this.isManagedByParent||this.advanceTime(.001*this.game.time.elapsedMS*this.playbackSpeed)}},{key:"switchMovieTo",value:function(t){this.game.flump.libraries[this.library].hasMovieSymbol(t)&&this.setup(this.game.flump.libraries[this.library].getMovieData(t))}},{key:"hasLabel",value:function(t){return this.getFrameOfLabel(t)}},{key:"getFrameOfLabel",value:function(t){for(var e=0;e<this.labels.length;e++)if(this.labels[e].indexOf(t)>=0)return e;return u}},{key:"loop",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.fallbackLoop=void 0,t&&t!==this.id||!e?t&&t!==this.id&&this.switchMovieTo(t):this.goToInternal(0,!0),this.state=h,this.stopFrame=u,this}},{key:"playOnce",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;return this.fallbackLoop=i,t&&t!==this.id||!e?t&&t!==this.id&&this.switchMovieTo(t):this.goToInternal(0,!0),this.playTo("<Last Frame>")}},{key:"playTo",value:function(t){return this.stopAt(t).play()}},{key:"play",value:function(){return this.state=this.framePosition!==this.stopFrame?h:"STOPPED",this}},{key:"playChildrenOnly",value:function(){return this.state="PLAYING_CHILDREN_ONLY",this}},{key:"stopAt",value:function(t){return this.stopFrame=this.getFrame(t),this}},{key:"stop",value:function(){return this.state="STOPPED",this}},{key:"goTo",value:function(t){return this.goToInternal(this.getFrame(t),!1)}},{key:"recursiveGoTo",value:function(t){return this.goToInternal(this.getFrame(t),!0)}},{key:"goToInternal",value:function(t,e){if(this.isUpdatingFrame)return this.pendingGoToFrame=t,this;var i=t;return i>=this.frameCount&&(i=this.frameCount),this.playTime=i/this.frameRate,this.updateFrame(i,0),e&&this.layers.forEach((function(i){i.currentSymbol.symbolType===n&&i.currentSymbol.goToInternal(t,e)})),this}},{key:"getFrame",value:function(t){if("number"==typeof t)return t;if("string"==typeof t){if((t=this.getFrameOfLabel(t))<0)throw new Error("Movie does not contain a frame label ".concat(t,"."));return t}throw new Error("Frame must be a string or number")}},{key:"toggleLayer",value:function(t,e){for(var i=0;i<this.layers.length;i++)if(this.layers[i].name===t)return this.layers[i].disabled=!e,this.layers[i].currentSymbol;throw new Error("Cannot find layer ".concat(t," in Movie ").concat(this.id,"."))}},{key:"isLayerEnabled",value:function(t){for(var e=0;e<this.layers.length;e++)if(this.layers[e].name===t)return this.layers[e].disabled=!toggle,!this.layers[e].disabled;throw new Error("Cannot find layer ".concat(t," in Movie ").concat(this.id,"."))}},{key:"removeChildAt",value:function(t){if(this.isUpdatingFrame)throw new Error("Cannot remove a layer while the Movie is updating its frame.");t<0&&(t=this.children.length-t);var i=j(L(e.prototype),"getChildAt",this).call(this,t),r=-1;if(this.layers)if(t<this.layers.length&&this.layers[t].currentSymbol===i)r=t;else for(var o=0;o<this.layers.length;++o)if(this.layers[o].currentSymbol===i){r=o;break}var s=!1;if(r>=0&&(i.symbolType===n&&i.setParentMovie(),1===this.layers[r].symbolCount?this.layers.splice(r,1):s=!0),j(L(e.prototype),"removeChildAt",this).call(this,t),s){var a=this.game.flump.createSymbolFrom(this.library);this.addChildAt(a,t),this.layers[r].replaceCurrentSymbol(a)}return i}},{key:"getLayerNames",value:function(){return this.layers.map((function(t){return t.name}))}},{key:"cleanUp",value:function(){for(;this.layers.length>0;){var t=this.layers.shift();t.cleanUp(),this.layerPool.push(t)}}},{key:"setParentMovie",value:function(t){this.parentMovie=t}},{key:"addedToLayer",value:function(){this.goTo(0),this.skipAdvanceTime=!0}},{key:"setup",value:function(t){if(void 0!==this.data&&this.cleanUp(),this.data=t,this.duration=this.frameCount/this.frameRate,this.isFlipbook)this.layers=[this.getFreeLayer().setup(this.layerData[0])];else for(var e=0;e<this.layerData.length;e++)this.layers.push(this.getFreeLayer().setup(this.layerData[e]));return this.goToInternal(0,!0)}},{key:"advanceTime",value:function(t){if(t<0)throw new Error("Invalid time ".concat(t));if(this.skipAdvanceTime)this.skipAdvanceTime=!1;else if("STOPPED"!==this.state){if(this.state===h&&this.frameCount>1){this.playTime+=t;var e=this.playTime;this.playTime>=this.duration&&(this.playTime%=this.duration);var i=this.playTime*this.frameRate;if(i<0?i=0:i>=this.frameCount&&(i=this.frameCount-1),this.stopFrame!==u){var r=this.framePosition<=this.stopFrame?this.stopFrame-this.framePosition:this.frameCount-this.framePosition+this.stopFrame;e*this.frameRate-this.framePosition>=r&&(this.state="STOPPED",i=this.stopFrame)}this.updateFrame(i,t)}for(var o=0;o<this.layers.length;o++)this.layers[o].currentSymbol.symbolType===n&&this.layers[o].currentSymbol.advanceTime(t)}}},{key:"updateFrame",value:function(t,e){if(t<0||t>=this.frameCount)throw new Error("Invalid frame ".concat(t,"."));if(this.isUpdatingFrame)throw new Error("Movie.updateFrame() is being called recursively");this.pendingGoToFrame=u,this.isUpdatingFrame=!0;var i,r,o=this.framePosition;this.framePosition=t,e<=0?(i=t,r=1):(i=o+1<this.frameCount?o+1:0,r=this.framePosition-o,(e>=this.duration||t<this.framePosition)&&(r+=this.frameCount));var s=0|i;if(this.lastFrameIdx!==s){this.lastFrameIdx=s;for(var a=this.lastFrameIdx,n=0;n<r&&this.pendingGoToFrame===u;++n){if(void 0!==this.labels[a])for(var l=0;l<this.labels[a].length&&(this.labelEvents.dispatch(this.labels[a][l]),this.pendingGoToFrame===u);l++);++a===this.frameCount&&(a=0)}}if(this.isUpdatingFrame=!1,this.pendingGoToFrame!==u){var h=this.pendingGoToFrame;this.pendingGoToFrame=u,this.goTo(h)}else if(t!==o)for(var f=0;f<this.layers.length;f++)this.layers[f].drawFrame(t);this.isManagedByParent||(this.framePosition===this.stopFrame?(void 0!==this.fallbackLoop&&this.loop(this.fallbackLoop),this.playbackComplete.dispatch()):this.framePosition<o&&this.playbackLoop.dispatch())}},{key:"getFreeLayer",value:function(){return this.layerPool.length>0?this.layerPool.shift():new F(this)}},{key:"restore",value:function(){return this.parentMovie=void 0,this.framePosition=u,this.stopFrame=u,this.pendingGoToFrame=u,this.lastFrameIdx=u,this.playTime=0,this.skipAdvanceTime=!1,this.isUpdatingFrame=!1,this.fallbackLoop=void 0,this.playbackSpeed=1,this.state=h,this.labelEvents.removeAll(),this.playbackComplete.removeAll(),this.playbackLoop.removeAll(),j(L(e.prototype),"restore",this).call(this)}}]),e}(P);function R(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function U(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function G(t,e,i){return e&&U(t.prototype,e),i&&U(t,i),t}var Y=function(){function t(e,i){var r,o=this;if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.key=i,this.isDestroyed=!1,this.imageAtlasMap={},this.atlases=[],this.symbolPools=(R(r={},a,[]),R(r,l,[]),R(r,n,[]),r),!this.game.cache.checkJSONKey(i))throw new Error("Cannot find library JSON for ".concat(i," in game cache."));if(this.data=this.game.cache.getJSON(i),void 0===this.data.movies)throw new Error("Library data for ".concat(this.key," is missing the 'movies' field."));this.movieMap={},this.data.movies.forEach((function(t,e){if(void 0===t.id)throw new Error("Movie ".concat(e," in ").concat(o.key," is missing the id field."));o.movieMap[t.id]=new O(o.key,t)})),this.generateFrameData()}return G(t,[{key:"frameRate",get:function(){if(void 0===this.data.frameRate)throw new Error("".concat(this.key," is missing the 'frameRate' field in its library.json file."));return this.data.frameRate}}]),G(t,[{key:"destroy",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.isDestroyed)throw new Error("".concat(this.key," has already been destroyed."));for(var i in this.movieMap)this.movieMap[i].destroy();for(this.movieMap=void 0;this.symbolPools[a].length>0;)this.symbolPools[a].shift().destroy();for(;this.symbolPools[l].length>0;)this.symbolPools[l].shift().destroy();for(;this.symbolPools[n].length>0;)this.symbolPools[n].shift().destroy();this.symbolPools=void 0,e&&(this.game.cache.removeJSON(this.key),this.atlases.forEach((function(e){return t.game.cache.removeImage(e,!0)}))),this.game=void 0,this.data=void 0,this.imageAtlasMap=void 0}},{key:"create",value:function(t){if(void 0===t)return this.getFreeSymbol(a);if(void 0!==this.imageAtlasMap[t])return this.getFreeSymbol(l,t);if(void 0!==this.movieMap[t])return this.getFreeSymbol(n,t);throw new Error("Cannot find symbol ".concat(t," in ").concat(this.key,"."))}},{key:"hasSymbol",value:function(t){if(this.isDestroyed)throw new Error("".concat(this.key," has been destroyed and has no symbols."));return this.hasImageSymbol(t)||this.hasMovieSymbol(t)}},{key:"hasMovieSymbol",value:function(t){if(this.isDestroyed)throw new Error("".concat(this.key," has been destroyed and has no symbols."));return void 0!==this.movieMap[t]}},{key:"hasImageSymbol",value:function(t){if(this.isDestroyed)throw new Error("".concat(this.key," has been destroyed and has no symbols."));return void 0!==this.imageAtlasMap[t]}},{key:"getMovieData",value:function(t){if(!this.hasMovieSymbol(t))throw new Error("".concat(this.key," does not contain MovieData for ").concat(t,"."));return this.movieMap[t]}},{key:"getFreeSymbol",value:function(t,e){if(this.isDestroyed)throw new Error("".concat(this.key," has been destroyed and has no symbols."));if(t!==a&&t!==l&&t!==n)throw new Error("Cannot get the symbol ".concat(e," in ").concat(this.key,"."));var i,r=e||a;return this.symbolPools[t]=this.symbolPools[t]||[],i=this.symbolPools[t].length>0?this.symbolPools[t].shift().restore():t===n?new D(this.game,this.frameRate):new P(this.game),t===l?i.loadTexture(this.imageAtlasMap[e],e):t===n&&i.setup(this.movieMap[e]),i.symbolType=t,i.symbolKey=r,i.symbolLibrary=this.key,i}},{key:"storeSymbol",value:function(t){if(this.isDestroyed)throw new Error("".concat(this.key," has been destroyed and no longer can store symbols. Use Symbol.destroy() instead."));if(void 0===t.symbolLibrary||t.symbolLibrary!==this.key)throw new Error("The provided symbol does not belong to this library.");if(t.symbolType!==a&&t.symbolType!==l&&t.symbolType!==n)throw new Error("Cannot store the symbol ".concat(t.symbolKey," in ").concat(this.key,"."));if(this.symbolPools[t.symbolType].indexOf(t)>=0)throw new Error("Attempting to store a symbol that is already in storage. Symbols in storages should not be referenced.");this.symbolPools[t.symbolType].push(t)}},{key:"generateFrameData",value:function(){var t=this;if(!this.isDestroyed){var e=this.data.textureGroups;if(void 0===e)throw new Error("Library JSON for ".concat(this.key," is missing the 'textureGroups' field (Array)."));e.forEach((function(e,i){if(void 0===e.atlases)throw new Error("Texture group ".concat(i," for ").concat(t.key," is missing the 'atlases' field (Array)."));e.atlases.forEach((function(e,r){if(void 0===e.file)throw new Error("Atlas ".concat(r," in texture group ").concat(i," for ").concat(t.key," is missing the 'file' field (string)."));if(void 0===e.textures)throw new Error("Atlas ".concat(r," in texture group ").concat(i," for ").concat(t.key," is missing the 'textures' field (Array)."));var o="".concat(t.key,"/").concat(e.file);if(!t.game.cache.checkImageKey(o))throw new Error("Cannot find image ".concat(o," in game cache."));t.atlases.push(o);var s=new Phaser.FrameData;e.textures.forEach((function(e,a){if(void 0===e.symbol)throw new Error("Texture ".concat(a," on atlas ").concat(r," in texture group ").concat(i," for ").concat(t.key," is missing the 'symbol' field (string)."));if(void 0===e.rect)throw new Error("Texture ".concat(a," on atlas ").concat(r," in texture group ").concat(i," for ").concat(t.key," is missing the 'rect' field (Array)."));s.addFrame(new Phaser.Frame(a,e.rect[0],e.rect[1],e.rect[2],e.rect[3],e.symbol)),t.imageAtlasMap[e.symbol]=o}));var a=t.game.cache._cache.image[o];a.frameData=s,a.frame=s.getFrame(0)}))}))}}}]),t}();function X(t){return(X="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function N(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function K(t){return(K=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function B(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function J(t,e){return(J=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var q=function(t){function e(t,i){var r,o,s;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),o=this,(r=!(s=K(e).call(this,t,i))||"object"!==X(s)&&"function"!=typeof s?B(o):s).game.flump=r.game.flump||B(r),r.libraries={},r}var i,r,o;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&J(t,e)}(e,Phaser.Plugin),i=e,(r=[{key:"addLibrary",value:function(t){if(void 0!==this.libraries[t])throw new Error("Flump library ".concat(t," already exists."));this.libraries[t]=new Y(this.game,t)}},{key:"removeLibrary",value:function(t){void 0!==this.libraries[t]&&(this.libraries[t].destroy(),delete this.libraries[t])}},{key:"hasLibrary",value:function(t){return void 0!==this.libraries[t]}},{key:"createSymbol",value:function(t){for(var e in this.libraries)if(this.libraries[e].hasSymbol(t))return this.libraries[e].create(t);throw new Error("Cannot find a library that contains a symbol for '".concat(t,"'."))}},{key:"createSymbolFrom",value:function(t,e){if(void 0===this.libraries[t])throw new Error("Flump library ".concat(t," does not exist. Be sure to call 'game.flump.addLibrary(\"").concat(t,"\")' before attempting to create a symbol."));return this.libraries[t].create(e)}}])&&N(i.prototype,r),o&&N(i,o),e}();i.d(e,"atlasLoader",(function(){return r})),i.d(e,"FlumpPlugin",(function(){return q}))}])}));